<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>~/ukint-vs • Profiling WASM Runtime in Substrate Using Perf</title><link href=/img/favicon.ico rel=icon type=image/png><link href=https://ukint-vs.github.io/atom.xml rel=alternate title=~/ukint-vs type=application/atom+xml><link href=https://ukint-vs.github.io/custom_subset.css rel=stylesheet><link href=https://fonts.googleapis.com rel=preconnect><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&family=Source+Sans+Pro&display=swap" rel=stylesheet><link href=https://ukint-vs.github.io/main.css media=screen rel=stylesheet><link href=# id=syntax_highlight rel=stylesheet><meta content="light dark" name=color-scheme><meta content="This post will guide you through webassembly profiling using perf." name=description><meta content="This post will guide you through webassembly profiling using perf." property=og:description><meta content="index, nofollow" name=robots><meta content=~/ukint-vs property=og:title><meta content=article property=og:type><meta content=https://ukint-vs.github.io/blog/wasmtime-substrate-profiling/ property=og:url><meta content=~/ukint-vs property=og:site_name><script src=https://ukint-vs.github.io/js/initializeTheme.min.js></script><script defer src=https://ukint-vs.github.io/js/themeSwitcher.min.js></script><script src="https://www.googletagmanager.com/gtag/js?id=G-0MCBDHH1PP" async></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-0MCBDHH1PP')</script><body><header><nav class=navbar><div class=nav-title><a class=home-title href=https://ukint-vs.github.io>~/ukint-vs</a></div><div class=nav-navs><ul><li><a class="nav-links no-hover-padding" href=https://ukint-vs.github.io/blog/>blog</a><li><a class="nav-links no-hover-padding" href=https://ukint-vs.github.io/archive/>archive</a><li><a class="nav-links no-hover-padding" href=https://ukint-vs.github.io/tags/>tags</a><li class=theme-switcher-wrapper><div class=theme-switcher></div></ul></div></nav></header><div class=content><main><article><div class=article-title>Profiling WASM Runtime in Substrate Using Perf</div><ul class=meta><li>23rd Jul 2023 •<li title="996 words "> 5 min read<li> • Tags: <li><a href=https://ukint-vs.github.io/tags/webassembly/>webassembly</a>, <li><a href=https://ukint-vs.github.io/tags/substrate/>substrate</a>, <li><a href=https://ukint-vs.github.io/tags/profiling/>profiling</a></ul><div class=toc-container><h3>Table of Contents</h3><ul><li><a href=https://ukint-vs.github.io/blog/wasmtime-substrate-profiling/#building-perf-from-source>Building Perf from Source</a><li><a href=https://ukint-vs.github.io/blog/wasmtime-substrate-profiling/#compiling-a-substrate-node-with-debug-symbols>Compiling a Substrate Node with Debug Symbols</a><li><a href=https://ukint-vs.github.io/blog/wasmtime-substrate-profiling/#collecting-profiling-data>Collecting Profiling Data</a> <ul><li><a href=https://ukint-vs.github.io/blog/wasmtime-substrate-profiling/#converting-perf-data>Converting Perf Data</a></ul><li><a href=https://ukint-vs.github.io/blog/wasmtime-substrate-profiling/#analyzing-the-report>Analyzing the Report</a><li><a href=https://ukint-vs.github.io/blog/wasmtime-substrate-profiling/#conclusion>Conclusion</a><li><a href=https://ukint-vs.github.io/blog/wasmtime-substrate-profiling/#references>References</a></ul></div><section class=body><p>As a developer at <a href=https://gear-tech.io rel=noopener target=_blank>Gear Tech</a>, I'm constantly looking for ways to optimize the performance of our blockchain. The Gear protocol, which we're building using Substrate, benefits greatly from these optimizations. In this blog post, I'll take you through our process of profiling a WASM runtime in Substrate using the Linux <code>perf</code> tool. This post is intended for developers who already have experience with Substrate and are looking to explore their codebase further.<p>Our main goal in this profiling process is to explore the performance of the runtime interface and identify any weak spots. By understanding where our code spends most of its time, we can focus our optimization efforts where they will have the most impact.<h2 id=building-perf-from-source><a aria-label="Anchor link for: building-perf-from-source" class="header-anchor no-hover-padding" href=#building-perf-from-source><span aria-hidden=true class=link-icon></span></a> Building Perf from Source</h2><p><em>Perf</em> is a powerful performance analysis tool for Linux 2.6+ based systems. It abstracts away CPU hardware differences and presents a simple command-line interface. As part of the Linux kernel source code, it requires compilation from source.<p>One of the reasons for building <em>perf</em> from source is to address the slow execution of the <code>perf script</code> command in the default version available in many Linux distributions. In our case, the <code>wasmtime jitdump</code> files are quite large, and running <code>perf script</code> on them using the default <code>perf</code> version can take hours. By building <code>perf</code> from source, we can apply patches to improve the execution speed of <code>perf script</code>. For more information about this issue and the patches applied, check out this article <a href=https://eighty-twenty.org/2021/09/09/perf-addr2line-speed-improvement/ rel=noopener target=_blank>~60x speed-up of Linux "perf"</a>.<p>Best way is to match your kernel version with linux repo. Mine is 5.19 but there is a bug with detecting <code>libcrypto.h</code> <a href=https://lore.kernel.org/lkml/Yrqcpr7ICzpsoGrc@krava/T/ rel=noopener target=_blank>more here</a>. So I will use latest v6.4 realease which also works.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">git</span></span><span class="z-meta z-function-call z-arguments z-shell"> clone https://github.com/torvalds/linux.git</span> <span class="z-keyword z-operator z-logical z-and z-shell">&&</span> <span class="z-meta z-function-call z-shell"><span class="z-support z-function z-cd z-shell">cd</span></span><span class="z-meta z-function-call z-arguments z-shell"> linux/tools/perf</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">git</span></span><span class="z-meta z-function-call z-arguments z-shell"> checkout v6.4</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">sudo</span></span><span class="z-meta z-function-call z-arguments z-shell"> apt install make gcc flex bison libdwarf-dev libdw-dev binutils-dev libcap-dev libelf-dev libnuma-dev libperf-dev python2 python2-dev python-setuptools libssl-dev libunwind-dev libdwarf-dev libunwindw zlib1g-dev liblzma-dev libaio-dev</span>

<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">make</span></span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">make</span></span><span class="z-meta z-function-call z-arguments z-shell"> install</span>
</span></code></pre><p>Now we have our perf installed in /root/bin/<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">➜</span></span><span class="z-meta z-function-call z-arguments z-shell">  perf git:(v6.4</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">✗</span></span><span class="z-meta z-function-call z-arguments z-shell"> /root/bin/perf<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>version</span></span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">perf</span></span><span class="z-meta z-function-call z-arguments z-shell"> version 6.4.g6995e2de6891</span>
</span></code></pre><h2 id=compiling-a-substrate-node-with-debug-symbols><a aria-label="Anchor link for: compiling-a-substrate-node-with-debug-symbols" class="header-anchor no-hover-padding" href=#compiling-a-substrate-node-with-debug-symbols><span aria-hidden=true class=link-icon></span></a> Compiling a Substrate Node with Debug Symbols</h2><p>To get the most out of our profiling, we'll need to compile our Substrate node with debug symbols and <code>runtime-banchmarks</code> feature.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-variable z-other z-readwrite z-assignment z-shell">RUSTFLAGS</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>-Cdebuginfo=0<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span> <span class="z-variable z-other z-readwrite z-assignment z-shell">WASM_BUILD_RUSTFLAGS</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>-Cdebuginfo=0<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cargo</span></span><span class="z-meta z-function-call z-arguments z-shell"> b<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>r</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>F</span> runtime-benchmarks</span>
</span></code></pre><p>We are passing <code>-Cdebuginfo=0</code> to <code>substrate-wasm-builder</code> to enable debug symbols inside WASM runtime.<h2 id=collecting-profiling-data><a aria-label="Anchor link for: collecting-profiling-data" class="header-anchor no-hover-padding" href=#collecting-profiling-data><span aria-hidden=true class=link-icon></span></a> Collecting Profiling Data</h2><p>Now that we have our tools ready, it's time to run some tests or a benchmark suite. We'll use the perf tool for this, and we'll enable jitdump at wasmtime to get detailed information about the JIT compilation process.<blockquote class="callout note"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 7H13V9H11V7ZM11 11H13V17H11V11Z" fill=currentColor></path></svg></div><div class=callout-content><p><strong>Note</strong><p>As of Wasmtime v6.0.2, which we're using in this guide, the available profiling strategies are <code>jitdump</code> and <code>vtune</code>. However, starting from Substrate v0.9.43, which uses Wasmtime v8.0.1, the available strategies are <code>jitdump</code> and <code>v8</code>.</div></blockquote><p>Some Linux distributions offer a <code>libc6-prof</code> package that includes frame pointers. This can help resolve symbols and call stacks that involve libc calls.<p>On Ubuntu, you can install this with:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">sudo</span></span><span class="z-meta z-function-call z-arguments z-shell"> apt-get install libc6-prof</span>
</span></code></pre><p>libc6-prof can be used with <code>LD_LIBRARY_PATH=/lib/libc6-prof/x86_64-linux-gnu</code><p>It may also be useful to have access to kernel addresses during profiling. These can be exposed with:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">sudo</span></span><span class="z-meta z-function-call z-arguments z-shell"> sh<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>c</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>echo 0 > /proc/sys/kernel/kptr_restrict<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>
</span></code></pre><p>The max stack depth is 127 by default. This is often too few. It can be increased with:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">sudo</span></span><span class="z-meta z-function-call z-arguments z-shell"> sh<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>c</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>echo 4000 > /proc/sys/kernel/perf_event_max_stack<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>
</span></code></pre><p>After all set we can now run our benchmarks to collect data. I will benchmark one of our syscalls <code>gr_send</code>.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-variable z-other z-readwrite z-assignment z-shell">LD_LIBRARY_PATH</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">/lib/libc6-prof/x86_64-linux-gnu</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">WASMTIME_PROFILING_STRATEGY</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>jitdump<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">perf</span></span><span class="z-meta z-function-call z-arguments z-shell"> record <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">                --</span>call-graph</span> dwarf<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>k</span> mono ./target/release/gear <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span>                benchmark pallet <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">                --</span>chain</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span>dev<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>steps</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span>50<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>repeat</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span>50<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>pallet</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span>pallet_gear <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">                --</span>extrinsic</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>gr_send<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>execution</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span>wasm <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">                --</span>wasm-execution</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span>compiled<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>heap-pages</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span>4096</span>
</span></code></pre><p>The <code>WASMTIME_PROFILING_STRATEGY</code> environment variable controls the profiling strategy used by <code>wasmtime</code>. The available options are:<ul><li><code>none</code>: No profiling.<li><code>jitdump</code>: Enables the jitdump profiling strategy. Collect profiling info for <code>jitdump</code> file format, used with perf on Linux.<li><code>v8</code>: Enables the v8 profiling strategy, which provides information about the execution of the WASM bytecode.</ul><p>Output will look like this: <img alt="Command Output" class=dimmable-image height=638 src=https://ukint-vs.github.io/img/perf_output.webp width=500><h3 id=converting-perf-data><a aria-label="Anchor link for: converting-perf-data" class="header-anchor no-hover-padding" href=#converting-perf-data><span aria-hidden=true class=link-icon></span></a> Converting Perf Data</h3><p>Once we've collected our profiling data, we'll need to inject the jitdump data into it.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">perf</span></span><span class="z-meta z-function-call z-arguments z-shell"> inject<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>jit</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>input</span> perf.data<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>output</span> perf.jit.data</span>
</span></code></pre><p>Next, we'll convert our perf data into a format that we can analyze.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">/root/bin/perf</span></span><span class="z-meta z-function-call z-arguments z-shell"> script<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>F</span> +pid <span class="z-keyword z-operator z-assignment z-redirection z-shell">></span> /tmp/report.perf</span>
</span></code></pre><h2 id=analyzing-the-report><a aria-label="Anchor link for: analyzing-the-report" class="header-anchor no-hover-padding" href=#analyzing-the-report><span aria-hidden=true class=link-icon></span></a> Analyzing the Report</h2><p>Finally, we can analyze our report. We'll use the <a href=https://profiler.firefox.com/ rel=noopener target=_blank>Firefox Profiler</a> for this. Simply upload your report and start analyzing!<div class=full-width><img alt="Firefox Profiler Screenshot" height=747 src=https://ukint-vs.github.io/img/firefox_profiler.webp width=2408></div><h2 id=conclusion><a aria-label="Anchor link for: conclusion" class="header-anchor no-hover-padding" href=#conclusion><span aria-hidden=true class=link-icon></span></a> Conclusion</h2><p>Profiling a WASM runtime in Substrate using perf is a powerful way to understand the performance characteristics of your blockchain. With this knowledge, you can optimize your code and make your blockchain faster and more efficient. This process has been a key part of our work at Gear Tech, and it's led to significant performance improvements in the Gear protocol. You can learn more about our work on <a href=https://github.com/gear-tech/gear rel=noopener target=_blank>GitHub</a>. Happy profiling!<p>In future posts, I'll dive deeper into the specific "weak spots" we identified in the runtime interface and the results of our profiling and optimization process. Stay tuned for more insights into our work at Gear!<h2 id=references><a aria-label="Anchor link for: references" class="header-anchor no-hover-padding" href=#references><span aria-hidden=true class=link-icon></span></a> References</h2><div class=references><p>Gear. <a href=https://github.com/gear-tech/gear rel=noopener target=_blank>https://github.com/gear-tech/gear</a>.<p>Substrate. <a href=https://github.com/paritytech/substrate rel=noopener target=_blank>https://github.com/paritytech/substrate</a><p>Mozilla. <em>JIT Profiling with perf</em>. <a href=https://firefox-source-docs.mozilla.org/performance/jit_profiling_with_perf.html rel=noopener target=_blank>https://firefox-source-docs.mozilla.org/performance/jit_profiling_with_perf.html</a>.<p>Wasmtime. <em>Profiling with Perf</em> <a href=https://docs.wasmtime.dev/examples-profiling-perf.html rel=noopener target=_blank>https://docs.wasmtime.dev/examples-profiling-perf.html</a></div></section><div class="comments centered-text" data-repo-id="MDEwOlJlcG9zaXRvcnkzNDkzMjI1Nzc=" data-category=Announcements data-category-id=DIC_kwDOFNI9Uc4CYOUr data-dark-theme=noborder_dark data-input-position=top data-lang=en data-lazy-loading=true data-light-theme=noborder_light data-mapping=specific data-reactions-enabled=1 data-repo=ukint-vs/ukint-vs.github.io data-strict=1 data-term=wasmtime-substrate-profiling id=comments><script async src=https://ukint-vs.github.io/js/giscus.min.js></script></div></article></main></div><footer><section><nav class="socials nav-navs"><ul><li><a class="nav-links no-hover-padding social" rel="noopener noreferrer" href=https://ukint-vs.github.io/atom.xml target=_blank> <img alt=feed src=https://ukint-vs.github.io/social_icons/rss.svg title=feed> </a><li><a class="nav-links no-hover-padding social" rel="noopener noreferrer" href=https://github.com/ukint-vs/ target=_blank> <img alt=github src=https://ukint-vs.github.io/social_icons/github.svg title=github> </a><li><a class="nav-links no-hover-padding social" rel="noopener noreferrer" href=https://www.linkedin.com/in/vadim-smirnov-b03853216/ target=_blank> <img alt=linkedin src=https://ukint-vs.github.io/social_icons/linkedin.svg title=linkedin> </a></ul></nav><div class=credits><small> Powered by <a href=https://www.getzola.org target=_blank>Zola</a> & <a href=https://github.com/welpo/tabi target=_blank>tabi</a></small></div></section></footer><script defer src=https://ukint-vs.github.io/js/copyCodeToClipboard.min.js></script>